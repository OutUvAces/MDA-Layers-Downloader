{% extends "base.html" %}

{% block title %}MDA Layers Downloader - Marine Data Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h1 class="h3 mb-0"><i class="fas fa-globe-asia"></i> Marine Data Layers Downloader</h1>
            </div>
            <div class="card-body">
                <p class="text-muted">Download marine geospatial data layers for visualization in tools like Google Earth. Select your country and choose the data layers you need.</p>

                <!-- Cache Status -->
                {% if cache_status %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-database"></i> Data Cache Status</h6>
                    <small>
                        Static layers (EEZ, territorial waters):
                        {% if cache_status.static_never_refreshed %}
                            <span class="text-danger">Never cached</span>
                        {% elif cache_status.static_age_days > 30 %}
                            <span class="text-warning">{{ "%.1f"|format(cache_status.static_age_days) }} days old (needs refresh)</span>
                        {% else %}
                            <span class="text-success">{{ "%.1f"|format(cache_status.static_age_days) }} days old</span>
                        {% endif %}
                        <br>
                        Dynamic layers (ocean currents, nav warnings):
                        {% if cache_status.dynamic_never_refreshed %}
                            <span class="text-danger">Never cached</span>
                        {% elif cache_status.dynamic_age_hours > 12 %}
                            <span class="text-warning">{{ "%.1f"|format(cache_status.dynamic_age_hours) }} hours old (needs refresh)</span>
                        {% else %}
                            <span class="text-success">{{ "%.1f"|format(cache_status.dynamic_age_hours) }} hours old</span>
                        {% endif %}
                    </small>
                </div>
                {% endif %}

                <form method="post" action="{{ url_for('start_download') }}">
                    <!-- Country Selection -->
                    <div class="mb-4">
                        <h5><i class="fas fa-map-marker-alt"></i> Country Selection</h5>
                        <div class="row">
                            <div class="col-md-12">
                                <label for="country" class="form-label">Country</label>
                                <select class="form-select" id="country" name="country" required>
                                    <option value="">Select a country...</option>
                                    {% for country_name, iso_code in countries %}
                                    <option value="{{ country_name }}">{{ country_name }} ({{ iso_code }})</option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" id="iso_code" name="iso_code" value="">
                            </div>
                        </div>
                    </div>

                    <!-- Country-Specific Layers -->
                    <div class="layer-card">
                        <h5><i class="fas fa-flag"></i> Country-Specific Layers</h5>
                        <p class="text-muted small">These layers are specific to the selected country</p>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="territorial" name="territorial">
                                    <label class="form-check-label" for="territorial">
                                        Territorial Waters (12nm)
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="contiguous" name="contiguous">
                                    <label class="form-check-label" for="contiguous">
                                        Contiguous Zone (24nm)
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="mpa" name="mpa">
                                    <label class="form-check-label" for="mpa">
                                        Marine Protected Areas
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="eez" name="eez">
                                    <label class="form-check-label" for="eez">
                                        Exclusive Economic Zone (200nm)
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="ecs" name="ecs">
                                    <label class="form-check-label" for="ecs">
                                        Extended Continental Shelf
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="seastate_country" name="seastate_country">
                                    <label class="form-check-label" for="seastate_country">
                                        Ocean Currents (Country)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Global Layers -->
                    <div class="layer-card">
                        <h5><i class="fas fa-globe"></i> Global Layers</h5>
                        <p class="text-muted small">These layers cover the entire world</p>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="cables" name="cables">
                            <label class="form-check-label" for="cables">
                                Submarine Cables
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="seastate_global" name="seastate_global">
                            <label class="form-check-label" for="seastate_global">
                                Ocean Currents (Global)
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="navwarnings" name="navwarnings">
                            <label class="form-check-label" for="navwarnings">
                                Navigation Warnings
                            </label>
                        </div>
                    </div>

                    <!-- Styling Options (matching desktop GUI) -->
                    <div class="layer-card">
                        <h5><i class="fas fa-palette"></i> Styling Options</h5>
                        <p class="text-muted small">Customize colors and opacity for each layer type</p>

                        <!-- Territorial Waters -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Territorial Waters (12nm)</label>
                            </div>
                            <div class="col-md-4">
                                <input type="color" class="form-control form-control-color" id="territorial_color" name="territorial_color" value="#ffff00" title="Yellow">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="territorial_opacity" name="territorial_opacity" value="20" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Contiguous Zone -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Contiguous Zone (24nm)</label>
                            </div>
                            <div class="col-md-4">
                                <input type="color" class="form-control form-control-color" id="contiguous_color" name="contiguous_color" value="#00ff00" title="Green">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="contiguous_opacity" name="contiguous_opacity" value="20" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- EEZ -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Exclusive Economic Zone (200nm)</label>
                            </div>
                            <div class="col-md-4">
                                <input type="color" class="form-control form-control-color" id="eez_color" name="eez_color" value="#0000ff" title="Blue">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="eez_opacity" name="eez_opacity" value="20" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- ECS -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Extended Continental Shelf</label>
                            </div>
                            <div class="col-md-4">
                                <input type="color" class="form-control form-control-color" id="ecs_color" name="ecs_color" value="#8b4513" title="Brown">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="ecs_opacity" name="ecs_opacity" value="20" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- MPA -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Marine Protected Areas</label>
                            </div>
                            <div class="col-md-4">
                                <input type="color" class="form-control form-control-color" id="mpa_color" name="mpa_color" value="#ff0000" title="Red">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="mpa_opacity" name="mpa_opacity" value="20" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Submarine Cables -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Submarine Cables</label>
                            </div>
                            <div class="col-md-4">
                                <input type="color" class="form-control form-control-color" id="cables_color" name="cables_color" value="#ffffff" title="White">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="cables_opacity" name="cables_opacity" value="50" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Ocean Currents -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Ocean Currents</label>
                            </div>
                            <div class="col-md-4">
                                <input type="color" class="form-control form-control-color" id="seastate_color" name="seastate_color" value="#000000" title="Black">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="seastate_opacity" name="seastate_opacity" value="100" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Warnings -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Navigation Warnings</label>
                            </div>
                            <div class="col-md-4">
                                <input type="color" class="form-control form-control-color" id="navwarnings_color" name="navwarnings_color" value="#ff0000" title="Red">
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="navwarnings_opacity" name="navwarnings_opacity" value="80" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Density controls for ocean currents -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Country Currents Density</label>
                                <select class="form-select" id="seastate_density_country" name="seastate_density_country">
                                    <option value="0.5">High</option>
                                    <option value="1.5" selected>Medium</option>
                                    <option value="3.0">Low</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Global Currents Density</label>
                                <select class="form-select" id="seastate_density_global" name="seastate_density_global">
                                    <option value="0.5">High</option>
                                    <option value="1.5" selected>Medium</option>
                                    <option value="3.0">Low</option>
                                </select>
                            </div>
                        </div>

                        <!-- Cables random color option -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="cables_random" name="cables_random">
                            <label class="form-check-label" for="cables_random">
                                Use random colors for submarine cables (overrides color setting)
                            </label>
                        </div>

                        <!-- Nav warnings custom colors option -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="navwarnings_custom" name="navwarnings_custom">
                            <label class="form-check-label" for="navwarnings_custom">
                                Use custom colors for navigation warnings
                            </label>
                        </div>

                        <!-- Reset to defaults button -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetStylingToDefaults()">
                                <i class="fas fa-undo"></i> Reset to Defaults
                            </button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-download"></i> Start Download
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-fill ISO code based on country selection via AJAX
document.getElementById('country').addEventListener('change', function() {
    const countrySelect = this;
    const isoInput = document.getElementById('iso_code');

    if (countrySelect.value) {
        // Make AJAX request to get ISO code
        fetch(`/get_iso_code?country=${encodeURIComponent(countrySelect.value)}`)
            .then(response => response.json())
            .then(data => {
                if (data.iso_code) {
                    isoInput.value = data.iso_code;
                } else {
                    isoInput.value = '';
                }
            })
            .catch(error => {
                console.error('Error fetching ISO code:', error);
                isoInput.value = '';
            });
    } else {
        isoInput.value = '';
    }
});

// Reset styling options to desktop defaults
function resetStylingToDefaults() {
    // Desktop default colors and opacities
    document.getElementById('territorial_color').value = '#ffff00';
    document.getElementById('territorial_opacity').value = '20';

    document.getElementById('contiguous_color').value = '#00ff00';
    document.getElementById('contiguous_opacity').value = '20';

    document.getElementById('eez_color').value = '#0000ff';
    document.getElementById('eez_opacity').value = '20';

    document.getElementById('ecs_color').value = '#8b4513';
    document.getElementById('ecs_opacity').value = '20';

    document.getElementById('mpa_color').value = '#ff0000';
    document.getElementById('mpa_opacity').value = '20';

    document.getElementById('cables_color').value = '#ffffff';
    document.getElementById('cables_opacity').value = '50';

    document.getElementById('seastate_color').value = '#000000';
    document.getElementById('seastate_opacity').value = '100';

    document.getElementById('navwarnings_color').value = '#ff0000';
    document.getElementById('navwarnings_opacity').value = '80';

    // Reset density selections to medium
    document.getElementById('seastate_density_country').value = '1.5';
    document.getElementById('seastate_density_global').value = '1.5';

    // Reset checkboxes
    document.getElementById('cables_random').checked = false;
    document.getElementById('navwarnings_custom').checked = false;
}
</script>
{% endblock %}