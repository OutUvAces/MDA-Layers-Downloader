{% extends "base.html" %}

{% block title %}MDA Layers Downloader - Marine Data Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex align-items-center">
                    <img src="{{ url_for('static', filename='favicon.ico') }}" alt="MDA Icon" style="height: 1.5em; margin-right: 0.5em;">
                    <h4 class="mb-0">MDA Layers Downloader</h4>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted">Download marine geospatial data layers for visualization in tools like Google Earth. Select your country and choose the data layers you need.</p>

                <!-- Cache Status -->
                {% if cache_status %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-database"></i> Data Cache Status</h6>
                    <small>
                        Static layers (EEZ, territorial waters):
                        {% if cache_status.static_never_refreshed %}
                            <span class="text-danger">Never cached</span>
                        {% elif cache_status.static_age_days > 30 %}
                            <span class="text-warning">{{ "%.1f"|format(cache_status.static_age_days) }} days old (needs refresh)</span>
                        {% else %}
                            <span class="text-success">{{ "%.1f"|format(cache_status.static_age_days) }} days old</span>
                        {% endif %}
                        <br>
                        Dynamic layers (ocean currents, nav warnings):
                        {% if cache_status.dynamic_never_refreshed %}
                            <span class="text-danger">Never cached</span>
                        {% elif cache_status.dynamic_age_hours > 12 %}
                            <span class="text-warning">{{ "%.1f"|format(cache_status.dynamic_age_hours) }} hours old (needs refresh)</span>
                        {% else %}
                            <span class="text-success">{{ "%.1f"|format(cache_status.dynamic_age_hours) }} hours old</span>
                        {% endif %}
                    </small>
                </div>
                {% endif %}

                <form method="post" action="{{ url_for('start_download') }}">
                <!-- Country Selection -->
                <div class="mb-4">
                    <h5><i class="fas fa-map-marker-alt"></i> Country</h5>
                        <div class="row">
                            <div class="col-md-12">
                                <label for="country" class="form-label">Country</label>
                                <select class="form-select" id="country" name="country" required>
                                    <option value="">Select a country...</option>
                                    {% for country_name, iso_code in countries %}
                                    <option value="{{ country_name }}">{{ country_name }} ({{ iso_code }})</option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" id="iso_code" name="iso_code" value="">
                            </div>
                        </div>
                    </div>

                <!-- Reset to Defaults Button -->
                <div class="text-end mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetStylingToDefaults()" id="reset_button">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>

                <!-- Country-Specific Layers Section -->
                <div class="layer-card">
                    <h5 class="mb-3"><i class="fas fa-flag"></i> Country-Specific Layers</h5>

                    <!-- EEZ -->
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="eez" name="eez">
                                <label class="form-check-label fw-bold" for="eez">
                                    Exclusive Economic Zone (200nm)
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://www.marineregions.org/" target="_blank" class="text-decoration-none">
                                    <a href="https://www.marineregions.org/" target="_blank" class="text-decoration-none">Marine Regions</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <input type="color" class="form-control form-control-color form-control-color-sm eez-control" id="eez_color" name="eez_color" value="#0000ff" title="Blue">
                                <select class="form-select form-select-sm eez-control" id="eez_opacity" name="eez_opacity">
                                    <option value="10">10%</option>
                                    <option value="20" selected>20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Territorial Waters -->
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="territorial" name="territorial">
                                <label class="form-check-label fw-bold" for="territorial">
                                    Territorial Waters (12nm)
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://www.marineregions.org/" target="_blank" class="text-decoration-none">
                                    <a href="https://www.marineregions.org/" target="_blank" class="text-decoration-none">Marine Regions</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <input type="color" class="form-control form-control-color form-control-color-sm territorial-control" id="territorial_color" name="territorial_color" value="#ffff00" title="Yellow">
                                <select class="form-select form-select-sm territorial-control" id="territorial_opacity" name="territorial_opacity">
                                    <option value="10">10%</option>
                                    <option value="20" selected>20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Contiguous Zone -->
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="contiguous" name="contiguous">
                                <label class="form-check-label fw-bold" for="contiguous">
                                    Contiguous Zone (24nm)
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://www.marineregions.org/" target="_blank" class="text-decoration-none">
                                    <a href="https://www.marineregions.org/" target="_blank" class="text-decoration-none">Marine Regions</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <input type="color" class="form-control form-control-color form-control-color-sm contiguous-control" id="contiguous_color" name="contiguous_color" value="#00ff00" title="Green">
                                <select class="form-select form-select-sm contiguous-control" id="contiguous_opacity" name="contiguous_opacity">
                                    <option value="10">10%</option>
                                    <option value="20" selected>20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Extended Continental Shelf -->
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="ecs" name="ecs">
                                <label class="form-check-label fw-bold" for="ecs">
                                    Extended Continental Shelf
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://www.marineregions.org/" target="_blank" class="text-decoration-none">
                                    <a href="https://www.marineregions.org/" target="_blank" class="text-decoration-none">Marine Regions</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <input type="color" class="form-control form-control-color form-control-color-sm ecs-control" id="ecs_color" name="ecs_color" value="#8b4513" title="Brown">
                                <select class="form-select form-select-sm ecs-control" id="ecs_opacity" name="ecs_opacity">
                                    <option value="10">10%</option>
                                    <option value="20" selected>20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Marine Protected Areas -->
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="mpa" name="mpa">
                                <label class="form-check-label fw-bold" for="mpa">
                                    Marine Protected Areas
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://www.protectedplanet.net/en/thematic-areas/marine-protected-areas" target="_blank" class="text-decoration-none">
                                    <a href="https://www.protectedplanet.net/en/thematic-areas/marine-protected-areas" target="_blank" class="text-decoration-none">Protected Planet (WDPA)</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <input type="color" class="form-control form-control-color form-control-color-sm mpa-control" id="mpa_color" name="mpa_color" value="#ff0000" title="Red">
                                <select class="form-select form-select-sm mpa-control" id="mpa_opacity" name="mpa_opacity">
                                    <option value="10">10%</option>
                                    <option value="20" selected>20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Ocean Currents (Country) -->
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="seastate_country" name="seastate_country">
                                <label class="form-check-label fw-bold" for="seastate_country">
                                    Ocean Currents (Country)
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://podaac.jpl.nasa.gov/dataset/OSCAR_L4_OC_NRT_V2.0" target="_blank" class="text-decoration-none">
                                    <a href="https://podaac.jpl.nasa.gov/dataset/OSCAR_L4_OC_NRT_V2.0" target="_blank" class="text-decoration-none">NASA OSCAR NRT</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <select class="form-select form-select-sm" id="seastate_density_country" name="seastate_density_country">
                                    <option value="0.5" selected>High</option>
                                    <option value="1.5">Medium</option>
                                    <option value="3.0">Low</option>
                                </select>
                                <input type="color" class="form-control form-control-color form-control-color-sm seastate-control" id="seastate_color" name="seastate_color" value="#000000" title="Black">
                                <select class="form-select form-select-sm seastate-control" id="seastate_opacity" name="seastate_opacity">
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100" selected>100%</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Global Layers Section -->
                <div class="layer-card">
                    <h5 class="mb-3"><i class="fas fa-globe"></i> Global Data Layers</h5>

                    <!-- Ocean Currents (Global) -->
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="seastate_global" name="seastate_global">
                                <label class="form-check-label fw-bold" for="seastate_global">
                                    Ocean Currents (Global)
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://podaac.jpl.nasa.gov/dataset/OSCAR_L4_OC_NRT_V2.0" target="_blank" class="text-decoration-none">
                                    <a href="https://podaac.jpl.nasa.gov/dataset/OSCAR_L4_OC_NRT_V2.0" target="_blank" class="text-decoration-none">NASA OSCAR NRT</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <select class="form-select form-select-sm" id="seastate_density_global" name="seastate_density_global">
                                    <option value="0.5">High</option>
                                    <option value="1.5">Medium</option>
                                    <option value="3.0" selected>Low</option>
                                </select>
                                <input type="color" class="form-control form-control-color form-control-color-sm seastate-control" id="seastate_color_global" name="seastate_color" value="#000000" title="Black">
                                <select class="form-select form-select-sm seastate-control" id="seastate_opacity_global" name="seastate_opacity">
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100" selected>100%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Warnings -->
                    <div class="row mb-2 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="navwarnings" name="navwarnings">
                                <label class="form-check-label fw-bold" for="navwarnings">
                                    Navigation Warnings
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://msi.nga.mil/NavWarnings" target="_blank" class="text-decoration-none">
                                    <a href="https://msi.nga.mil/NavWarnings" target="_blank" class="text-decoration-none">NGA MSI</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <input type="color" class="form-control form-control-color form-control-color-sm navwarnings-color-control" id="navwarnings_color" name="navwarnings_color" value="#ff0000" title="Red">
                                <select class="form-select form-select-sm navwarnings-opacity-control" id="navwarnings_opacity" name="navwarnings_opacity">
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50">50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80" selected>80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                                <div class="form-check mb-0 ms-2">
                                    <input class="form-check-input" type="checkbox" id="navwarnings_custom" name="navwarnings_custom" checked>
                                    <label class="form-check-label small" for="navwarnings_custom">
                                        Custom
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submarine Cables -->
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6">
                            <div class="form-check mb-0">
                                <input class="form-check-input layer-checkbox" type="checkbox" id="cables" name="cables">
                                <label class="form-check-label fw-bold" for="cables">
                                    Submarine Cables
                                </label>
                            </div>
                            <small class="text-muted ms-3">
                                <a href="https://www.submarinecablemap.com/" target="_blank" class="text-decoration-none">
                                    <a href="https://www.submarinecablemap.com/" target="_blank" class="text-decoration-none">SubmarineCableMap</a>
                                </a>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-inline-flex align-items-center gap-2">
                                <input type="color" class="form-control form-control-color form-control-color-sm cables-color-control" id="cables_color" name="cables_color" value="#ffffff" title="White">
                                <select class="form-select form-select-sm cables-opacity-control" id="cables_opacity" name="cables_opacity">
                                    <option value="10">10%</option>
                                    <option value="20">20%</option>
                                    <option value="30">30%</option>
                                    <option value="40">40%</option>
                                    <option value="50" selected>50%</option>
                                    <option value="60">60%</option>
                                    <option value="70">70%</option>
                                    <option value="80">80%</option>
                                    <option value="90">90%</option>
                                    <option value="100">100%</option>
                                </select>
                                <div class="form-check mb-0 ms-2">
                                    <input class="form-check-input" type="checkbox" id="cables_random" name="cables_random" checked>
                                    <label class="form-check-label small" for="cables_random">
                                        Random
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Country-Specific Layers Section -->
                <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" id="submit_button" class="btn btn-primary btn-lg" disabled style="opacity: 0.5;">
                            <i class="fas fa-download"></i> Start Download
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script>
// Initialize form state and event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners
    setupEventListeners();

    // Initialize form state
    updateFormState();

    // Initial button state check
    updateSubmitButton();
});

// Set up all event listeners
function setupEventListeners() {
    // Country selection
    document.getElementById('country').addEventListener('change', function() {
        const countrySelect = this;
        const isoInput = document.getElementById('iso_code');

        if (countrySelect.value) {
            // Make AJAX request to get ISO code
            fetch(`/get_iso_code?country=${encodeURIComponent(countrySelect.value)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.iso_code) {
                        isoInput.value = data.iso_code;
                    } else {
                        isoInput.value = '';
                    }
                })
                .catch(error => {
                    console.error('Error fetching ISO code:', error);
                    isoInput.value = '';
                });
        } else {
            isoInput.value = '';
        }
        updateSubmitButton();
    });

    // Layer checkboxes
    document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateFormState();
            updateSubmitButton();
        });
    });

    // Special checkboxes (random colors, custom colors)
    document.getElementById('cables_random').addEventListener('change', function() {
        updateCablesControls();
    });

    document.getElementById('navwarnings_custom').addEventListener('change', function() {
        updateNavWarningsControls();
    });

    // Ocean currents checkboxes for density switching
    document.getElementById('seastate_country').addEventListener('change', function() {
        if (this.checked) {
            // Auto-switch country currents to High density when selected
            document.getElementById('seastate_density_country').value = '0.5';
        } else {
            // Reset to Low when unchecked
            document.getElementById('seastate_density_country').value = '3.0';
        }
    });
}

// Update form state based on checkbox selections
function updateFormState() {
    updateCablesControls();
    updateNavWarningsControls();
    updateCurrentsControls();
}

// Enable/disable cables color/opacity controls based on random checkbox
function updateCablesControls() {
    const randomChecked = document.getElementById('cables_random').checked;
    const colorControl = document.getElementById('cables_color');
    const opacityControl = document.getElementById('cables_opacity');

    colorControl.disabled = randomChecked;
    opacityControl.disabled = randomChecked;

    // Grey out appearance for controls only (not the checkbox)
    if (randomChecked) {
        colorControl.style.opacity = '0.5';
        opacityControl.style.opacity = '0.5';
    } else {
        colorControl.style.opacity = '1';
        opacityControl.style.opacity = '1';
    }
}

// Enable/disable nav warnings color/opacity controls based on custom checkbox
function updateNavWarningsControls() {
    const customChecked = document.getElementById('navwarnings_custom').checked;
    const colorControl = document.getElementById('navwarnings_color');
    const opacityControl = document.getElementById('navwarnings_opacity');

    colorControl.disabled = customChecked;
    opacityControl.disabled = customChecked;

    // Grey out appearance for controls only (not the checkbox)
    if (customChecked) {
        colorControl.style.opacity = '0.5';
        opacityControl.style.opacity = '0.5';
    } else {
        colorControl.style.opacity = '1';
        opacityControl.style.opacity = '1';
    }
}

// Update currents controls visibility
function updateCurrentsControls() {
    // Currents controls are always enabled - density switching is handled by checkbox change event
}

// Update submit button state based on form validity
function updateSubmitButton() {
    const submitButton = document.getElementById('submit_button');
    const countrySelected = document.getElementById('country').value.trim() !== '';
    const anyLayerSelected = Array.from(document.querySelectorAll('.layer-checkbox')).some(cb => cb.checked);

    // Enable button if either country layers are selected with a country, or global layers are selected
    const countryLayersSelected = ['territorial', 'contiguous', 'mpa', 'eez', 'ecs', 'seastate_country']
        .some(id => document.getElementById(id).checked);
    const globalLayersSelected = ['cables', 'seastate_global', 'navwarnings']
        .some(id => document.getElementById(id).checked);

    const shouldEnable = (countryLayersSelected && countrySelected) || globalLayersSelected;

    submitButton.disabled = !shouldEnable;
    submitButton.style.opacity = shouldEnable ? '1' : '0.5';
}

// Reset styling options to desktop defaults (matching Tkinter preload)
function resetStylingToDefaults() {
    // Desktop default colors and opacities
    document.getElementById('eez_color').value = '#0000ff';
    document.getElementById('eez_opacity').value = '20';

    document.getElementById('territorial_color').value = '#ffff00';
    document.getElementById('territorial_opacity').value = '20';

    document.getElementById('contiguous_color').value = '#00ff00';
    document.getElementById('contiguous_opacity').value = '20';

    document.getElementById('ecs_color').value = '#8b4513';
    document.getElementById('ecs_opacity').value = '20';

    document.getElementById('mpa_color').value = '#ff0000';
    document.getElementById('mpa_opacity').value = '20';

    document.getElementById('cables_color').value = '#ffffff';
    document.getElementById('cables_opacity').value = '50';

    document.getElementById('seastate_color').value = '#000000';
    document.getElementById('seastate_opacity').value = '100';

    document.getElementById('navwarnings_color').value = '#ff0000';
    document.getElementById('navwarnings_opacity').value = '80';

    // Reset density selections - NEVER default to Medium (desktop behavior)
    // Global currents: Low, Country currents: Low (will auto-switch to High when country selected)
    document.getElementById('seastate_density_country').value = '3.0'; // Low
    document.getElementById('seastate_density_global').value = '3.0';   // Low

    // Reset checkboxes to desktop defaults (random/custom checked)
    document.getElementById('cables_random').checked = true;
    document.getElementById('navwarnings_custom').checked = true;

    // Update form state after reset
    updateFormState();
    updateSubmitButton();
}
</script>
{% endblock %}
